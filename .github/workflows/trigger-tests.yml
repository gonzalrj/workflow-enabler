name: Trigger remote regression and link to report (robust)

on:
  push:
    branches:
      - main

env:
  REMOTE_OWNER: gonzalrj
  REMOTE_REPO: qa-practice-swaglabs
  REMOTE_WORKFLOW_FILE: manual-regression-sharded.yml
  REMOTE_BRANCH: main
  POLL_INTERVAL_SECONDS: 10
  TIMEOUT_MINUTES: 60   # increased timeout (tweak as needed)

jobs:
  trigger-remote:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Dispatch remote workflow via REST
        id: dispatch
        env:
          PAT: ${{ secrets.REMOTE_PAT }}
        run: |
          set -euo pipefail
          echo "Triggering remote workflow..."
          payload=$(jq -n --arg ref "${REMOTE_BRANCH}" '{ref: $ref}')
          status=$(curl -sS -o /dev/stderr -w "%{http_code}" \
            -X POST \
            -H "Authorization: token ${PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/workflows/${REMOTE_WORKFLOW_FILE}/dispatches" \
            -d "${payload}")
          if [ "$status" != "204" ]; then
            echo "Failed to trigger workflow. HTTP $status"
            exit 1
          fi
          echo "Remote workflow dispatched."

      - name: Poll for remote run and wait for completion
        id: poll
        env:
          PAT: ${{ secrets.REMOTE_PAT }}
        run: |
          set -euo pipefail

          poll_interval=${POLL_INTERVAL_SECONDS}
          timeout_seconds=$(( TIMEOUT_MINUTES * 60 ))
          started_at=$(date +%s)

          echo "Looking for the newly-created run for workflow '${REMOTE_WORKFLOW_FILE}' on branch '${REMOTE_BRANCH}'..."

          run_id=""
          # Keep trying until we find a run (respect timeout)
          while [ -z "$run_id" ]; do
            now=$(date +%s)
            if [ $((now - started_at)) -ge $timeout_seconds ]; then
              echo "Timed out waiting for remote run to appear after ${TIMEOUT_MINUTES} minutes."
              # exit non-zero to fail early â€” change behavior if you prefer different handling
              exit 2
            fi

            runs_resp=$(curl -sS -H "Authorization: token ${PAT}" \
              "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/workflows/${REMOTE_WORKFLOW_FILE}/runs?branch=${REMOTE_BRANCH}&event=workflow_dispatch&per_page=5")

            run_id=$(echo "$runs_resp" | jq -r '.workflow_runs[0].id // empty')
            if [ -n "$run_id" ]; then
              echo "Found run id=$run_id"
              break
            fi

            echo "No run yet; sleeping ${poll_interval}s..."
            sleep "$poll_interval"
          done

          echo "Waiting for run ${run_id} to reach completed status..."
          # Poll until this particular run reaches completed
          while true; do
            now=$(date +%s)
            if [ $((now - started_at)) -ge $timeout_seconds ]; then
              echo "Timed out waiting for run ${run_id} to finish after ${TIMEOUT_MINUTES} minutes."
              exit 3
            fi

            run_resp=$(curl -sS -H "Authorization: token ${PAT}" \
              "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}")

            status=$(echo "$run_resp" | jq -r '.status // empty')
            conclusion=$(echo "$run_resp" | jq -r '.conclusion // empty')

            echo "run_id=${run_id} status=${status} conclusion=${conclusion}"

            if [ "$status" = "completed" ]; then
              echo "Remote run completed with conclusion=${conclusion}"
              # export outputs for workflow
              echo "run_id=${run_id}" >> $GITHUB_OUTPUT
              echo "conclusion=${conclusion}" >> $GITHUB_OUTPUT
              exit 0
            fi

            sleep "$poll_interval"
          done

      - name: Output direct links to remote run & artifacts
        id: links
        run: |
          run_id="${{ steps.poll.outputs.run_id }}"
          if [ -z "$run_id" ]; then
            echo "No run_id found in poll step outputs. The poll step may have failed or timed out."
            exit 1
          fi

          remote_run_url="https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}"
          remote_artifacts_url="https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}/artifacts"

          echo ""
          echo "===================="
          echo "  REMOTE RUN LINKS"
          echo "===================="
          echo "Remote Run URL: $remote_run_url"
          echo ""
          echo "Artifacts URL (Allure report, zipped): $remote_artifacts_url"
          echo "===================="
          echo ""

          echo "remote_run_url=${remote_run_url}" >> $GITHUB_OUTPUT
          echo "remote_artifacts_url=${remote_artifacts_url}" >> $GITHUB_OUTPUT

      - name: Fail if remote run finished but did not succeed
        if: ${{ steps.poll.outputs.conclusion != '' && steps.poll.outputs.conclusion != 'success' }}
        run: |
          echo "Remote workflow finished with conclusion: '${{ steps.poll.outputs.conclusion }}'. Marking as failed."
          exit 1

      - name: Succeed if remote run passed
        if: ${{ steps.poll.outputs.conclusion == 'success' }}
        run: |
          echo "Remote workflow succeeded (conclusion=success)."
