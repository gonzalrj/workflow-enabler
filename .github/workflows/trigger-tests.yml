name: Trigger remote regression and link to report

on:
  push:
    branches:
      - main

env:
  REMOTE_OWNER: gonzalrj
  REMOTE_REPO: qa-practice-swaglabs
  REMOTE_WORKFLOW_FILE: manual-regression-sharded.yml
  REMOTE_BRANCH: main
  POLL_INTERVAL_SECONDS: 10
  TIMEOUT_MINUTES: 30

jobs:
  trigger-remote:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: sudo apt-get update -y && sudo apt-get install -y jq

      - name: Dispatch remote workflow via REST
        id: dispatch
        env:
          PAT: ${{ secrets.REMOTE_PAT }}
        run: |
          set -euo pipefail
          echo "Triggering remote workflow..."

          payload=$(jq -n --arg ref "${REMOTE_BRANCH}" '{ref: $ref}')
          status=$(curl -sS -o /dev/stderr -w "%{http_code}" \
            -X POST \
            -H "Authorization: token ${PAT}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/workflows/${REMOTE_WORKFLOW_FILE}/dispatches" \
            -d "${payload}")

          if [ "$status" != "204" ]; then
            echo "Failed to trigger workflow. HTTP $status"
            exit 1
          fi

          echo "Remote workflow dispatched."

      - name: Poll for remote workflow to start and finish
        id: poll
        env:
          PAT: ${{ secrets.REMOTE_PAT }}
        run: |
          set -euo pipefail

          poll_interval=${POLL_INTERVAL_SECONDS}
          timeout_seconds=$(( TIMEOUT_MINUTES * 60 ))
          start=$(date +%s)

          echo "Waiting for remote run to appear..."

          run_id=""

          while [ -z "$run_id" ]; do
            response=$(curl -sS \
              -H "Authorization: token ${PAT}" \
              "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/workflows/${REMOTE_WORKFLOW_FILE}/runs?branch=${REMOTE_BRANCH}&event=workflow_dispatch&per_page=1")

            run_id=$(echo "$response" | jq -r '.workflow_runs[0].id // empty')

            [ -n "$run_id" ] && break

            now=$(date +%s)
            [ $((now - start)) -gt $timeout_seconds ] && exit 1

            sleep $poll_interval
          done

          echo "Remote run ID: $run_id"
          echo "run_id=$run_id" >> $GITHUB_OUTPUT

          echo "Waiting for remote run to finish..."

          while true; do
            run_json=$(curl -sS \
              -H "Authorization: token ${PAT}" \
              "https://api.github.com/repos/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}")

            status=$(echo "$run_json" | jq -r '.status')
            conclusion=$(echo "$run_json" | jq -r '.conclusion')

            echo "Status: $status | Conclusion: $conclusion"

            if [ "$status" = "completed" ]; then
              echo "conclusion=$conclusion" >> $GITHUB_OUTPUT
              break
            fi

            now=$(date +%s)
            [ $((now - start)) -gt $timeout_seconds ] && exit 1

            sleep $poll_interval
          done

      - name: Output direct links to remote run & artifacts
        id: links
        run: |
          run_id="${{ steps.poll.outputs.run_id }}"
          echo ""
          echo "===================="
          echo "  REMOTE RUN LINKS"
          echo "===================="
          echo "Remote Run URL:"
          echo "https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}"
          echo ""
          echo "Artifacts URL (Allure report, zipped):"
          echo "https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}/artifacts"
          echo ""
          echo "===================="

          # expose as workflow outputs
          echo "remote_run_url=https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}" >> $GITHUB_OUTPUT
          echo "remote_artifacts_url=https://github.com/${REMOTE_OWNER}/${REMOTE_REPO}/actions/runs/${run_id}/artifacts" >> $GITHUB_OUTPUT

      - name: Mark job as failed if remote workflow failed
        if: ${{ steps.poll.outputs.conclusion != 'success' }}
        run: |
          echo "Remote workflow FAILED."
          exit 1

      - name: Mark job as success if remote passed
        if: ${{ steps.poll.outputs.conclusion == 'success' }}
        run: |
          echo "Remote workflow succeeded."
          echo "Click link above to download Allure report."
